name: Deploy to Staging

on:
  push:
    branches: [staging]
  workflow_dispatch:

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push staging image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/envoyou-sec-api:staging
            ${{ secrets.DOCKER_USERNAME }}/envoyou-sec-api:staging-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to staging server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            #!/bin/bash
            set -euo pipefail

            # --- Konfigurasi ---
            PROJECT_DIR="$HOME/envoyou-staging"
            REPO_URL="git@github.com:ENVOYou/envoyou-sec-api-v1.git"
            COMPOSE_FILE="docker-compose.staging.yml"

            # --- Fungsi Bantuan ---
            log() {
                echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"
            }

            retry() {
                local max_attempts=5
                local timeout=2
                local attempt=0
                local exitCode=0

                while (( attempt < max_attempts )); do
                    if "$@"; then
                        return 0
                    fi
                    exitCode=$?
                    log "‚ö†Ô∏è Perintah gagal! Mencoba lagi dalam $timeout detik..."
                    sleep $timeout
                    attempt=$((attempt + 1))
                    timeout=$((timeout * 2))
                done
                return $exitCode
            }

            wait_for_health() {
                local service_name=$1
                local health_url=$2
                local max_attempts=30
                local attempt=0

                log "‚è≥ Menunggu $service_name agar siap..."
                while (( attempt < max_attempts )); do
                    if curl -fsS -L --max-time 10 "$health_url" > /dev/null 2>&1; then
                        log "‚úÖ $service_name already healthy!"
                        return 0
                    fi
                    sleep 10
                    attempt=$((attempt + 1))
                done
                log "‚ùå $service_name failed to become healthy after several attempts."
                return 1
            }

            # --- Fungsi Utama ---
            main() {
                log "üöÄ Memulai proses deployment..."

                # 1. Login ke Docker Hub
                log "üîê Melakukan login ke Docker Hub..."
                echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

                # 2. Update repository
                log "üì• Mengupdate repository dari Git..."
                if [[ -d "$PROJECT_DIR" ]]; then
                    cd "$PROJECT_DIR"
                    git fetch --all && git reset --hard origin/staging
                else
                    git clone "$REPO_URL" "$PROJECT_DIR"
                    cd "$PROJECT_DIR"
                fi

                # 3. Buat file .env lengkap dari GitHub Secrets
                log "üìù Membuat file .env..."
            cat <<EOF > .env
            # ---- General ----
            ENVIRONMENT=${{ secrets.ENVIRONMENT }}
            DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            DOCKER_PASSWORD=${{ secrets.DOCKER_PASSWORD }}

            # ---- Django / FastAPI ----
            DATABASE_URL=${{ secrets.STAGING_DATABASE_URL }}
            REDIS_URL=${{ secrets.STAGING_REDIS_URL }}
            SECRET_KEY=${{ secrets.STAGING_SECRET_KEY }}
            JWT_ALGORITHM=${{ secrets.STAGING_JWT_ALGORITHM }}
            ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
            CORS_ORIGINS=${{ secrets.STAGING_CORS_ORIGINS }}
            LOCAL_HEALTH_URL=${{ secrets.LOCAL_HEALTH_URL }}

            # ---- Security / Auth ----
            RECAPTCHA_SECRET_KEY=${{ secrets.RECAPTCHA_SECRET_KEY }}
            RECAPTCHA_SCORE_THRESHOLD=${{ secrets.RECAPTCHA_SCORE_THRESHOLD }}
            STACK_SECRET_SERVER_KEY=${{ secrets.STACK_SECRET_SERVER_KEY }}

            # ---- Feature Flags ----
            ENABLE_METRICS=${{ secrets.ENABLE_METRICS }}
            ENABLE_RATE_LIMITING=${{ secrets.ENABLE_RATE_LIMITING }}

            # ---- Misc ----
            STAGING_HOST=${{ secrets.STAGING_HOST }}
            STAGING_USER=${{ secrets.STAGING_USER }}
            SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}
            EOF
                log "üîí Mengamankan file .env..."
                chmod 600 .env

                # ‚úÖ Muat variabel environment
                set -a
                source .env
                set +a

                # 4. Hentikan dan bersihkan kontainer lama
                log "üõë Menghentikan dan membersihkan kontainer lama..."
                docker compose -f "$COMPOSE_FILE" down --volumes --remove-orphans || true

                # 5. BERSIHKAN DOCKER SYSTEM (LANGKAH BARU)
                log "üßπ Membersihkan image, cache, dan network yang tidak terpakai..."
                docker system prune -af --volumes || true

                # 6. Tarik image baru dengan retry
                log "üì¶ Menarik image Docker terbaru..."
                retry docker compose -f "$COMPOSE_FILE" pull

                # 7. Jalankan layanan
                log "üîÑ Menjalankan layanan baru..."
                docker compose -f "$COMPOSE_FILE" up -d --force-recreate

                # 8. Tunggu API siap
                wait_for_health "API" "$LOCAL_HEALTH_URL"

                # 9. Jalankan migrasi database
                log "üóÑÔ∏è Menjalankan migrasi database..."
                retry docker compose -f "$COMPOSE_FILE" run --rm api alembic upgrade head

                # 10. Lakukan pengecekan kesehatan akhir
                log "üè• Melakukan pengecekan kesehatan akhir untuk semua layanan..."
                wait_for_health "API" "$LOCAL_HEALTH_URL"

                log "‚úÖ Deployment selesai dengan sukses!"
            }

            # --- Eksekusi ---
            trap 'log "‚ùå Deployment gagal di baris $LINENO"' ERR
            main

      - name: Notify deployment status
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}

        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
